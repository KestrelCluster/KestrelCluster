#!/bin/bash

# This script creates a new entry in the /etc/exports file for exporting
# "${image_name}" image. Since the exported directory has to be "mount binded" 
# to the real directory containing the image with nfs4, we also need to add an 
# entry on the fstab file for the "mount binding"

new_mount_dir=${NFS4_ROOT}/kestrel/${image_name}

# Remove old entries
sed -ri "/[^#]*\/kestrel\/${image_name}([^0-9A-Za-z]+|$)/d" ${FILE}


comment="# Autogenerated by kestrel_reconfigure"

grep -Eq "${comment}" ${FILE} || echo -e "\n${comment}" >> ${FILE}

sed -ri "/${comment}/a\
${new_mount_dir} *(ro,async,nohide,no_subtree_check,no_root_squash) \n\
${new_mount_dir}/lib/modules/ *(ro,async,nohide,no_subtree_check,no_root_squash) \
" ${FILE}

