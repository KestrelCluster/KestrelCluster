#!/bin/bash

# This script creates a new entry in the /etc/exports file for exporting
# "${image_name}" image. Since the exported directory has to be "mount binded" 
# to the real directory containing the image with nfs4, we also need to add an 
# entry on the fstab file for the "mount binding"

if [ "$1" == "uninstall" ]; then

    mount_dir=$(mount | sed -rn \
                "s/.*\s([^\ \t]*\/kestrel\/${image_name})\s+.*/\1/p")

    # umount the image
    echo "umount \"${mount_dir}/lib/modules\""
    umount ${mount_dir}/lib/modules

    echo "umount \"${mount_dir}\""
    umount ${mount_dir}

    # Delete from the fstab
    sed -ri "/[^#]*\/kestrel\/${image_name}/d" ${FILE}

else

new_mount_dir=${NFS4_ROOT}/kestrel/${image_name}

install -d ${new_mount_dir}

# Remove old entries
sed -ri "/[^#]*[[:space:]].*\/kestrel\/${image_name}([^0-9A-Za-z]+|$)/d" ${FILE}

comment="# Autogenerated by kestrel_reconfigure"

grep -Eq "${comment}" ${FILE} || echo -e "\n${comment}" >> ${FILE}

# Add the entry after the comment
sed -ri "/${comment}/a\
${image_dir} \t${new_mount_dir} \tnode \tbind \t0 \t0 \n\
/lib/modules/ \t${new_mount_dir}/lib/modules/ \tnode \tbind \t0 \t0 \
" ${FILE}

# Check if the image is already mounted somewhere else
mount_dir=$(mount | sed -rn \
           "s/.*\s([^\ \t]*\/kestrel\/${image_name})\s+.*/\1/p")

echo "old mount_dir: ${mount_dir}"
echo "new mount_dir: ${new_mount_dir}"

# If the new mount dir is different from the old one, mount bind to the new dir
# first and then umount the old one
if [[ "${mount_dir}" != "${new_mount_dir}" ]]; then
    
    echo "Mounting new mount dir"
    
    echo "mount --bind \"${KESTREL_IMAGE_DIR}/${image_name}\" \"${new_mount_dir}\""
    echo "mount --bind \"/lib/modules\" \"${new_mount_dir}/lib/modules\""
    
    mount --bind ${KESTREL_IMAGE_DIR}/${image_name} ${new_mount_dir}
    mount --bind /lib/modules ${new_mount_dir}/lib/modules
    
    if [ -n "${mount_dir}" ]; then
        echo "umount \"${mount_dir}/lib/modules\""
        echo "umount \"${mount_dir}\""
                
        umount ${mount_dir}/lib/modules
        umount ${mount_dir}
    fi
fi

fi
