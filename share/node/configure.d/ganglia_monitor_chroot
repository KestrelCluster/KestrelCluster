#!/bin/bash

# This script reconfigures gmond's config file :
#   - Sets gmond's user to ganglia
#   - Sets gmond to deaf mode. A node doesn't listen to other nodes.
#   - Sets gmond's cluster info : name, owner, latlong and url
#   - Sets udp_send_channel to unicast instead of multicast

# Note: Although the following sed script may seem too complex and a simpler
# template based approach would seem more appropiate, this is the best approach
# since it just tries to modify only some sections of the default config. 
# In the future the default gmond config may include new interesting metrics,
# which will work out of the box.


GMOND_CONF=/etc/ganglia/gmond.conf

# Backup original gmond
if [ ! -e ${GMOND_CONF}.bak ]; then
   cp ${GMOND_CONF} ${GMOND_CONF}.bak
fi

cat <<MESSAGE > $GMOND_CONF
/*
File autogenerated by kestrel-reconfigure on $(date)
 
Do not edit this file directly!
 
If you want to edit it, the best approach is to edit the autogeneration 
template. Copy the script from /usr/share/kestrel/node/config.d/ganglia_chroot
to /etc/kestrel/node/config.d/ganglia_chroot, and modify it. 

A simpler option is to create a simple template :

Create a file /etc/kestrel/node/config.d/ganglia_chroot with the content :
 #!/bin/bash
 cat <<MESSAGE > $GMOND_CONF
 
 ...The edited file...
 
 MESSAGE

*/
MESSAGE

# Create a new default config file
gmond -t >> $GMOND_CONF

# Set the user as ganglia
sed -ri 's/^([[:space:]]*user[[:space:]]*=).*/\1 ganglia/' $GMOND_CONF

# Set gmond as deaf. A node doesn't need to listen to other nodes.
sed -ri 's/^([[:space:]]*deaf[[:space:]]*=).*/\1 yes/' $GMOND_CONF

# Replace the cluster section
sed -ri "
# Select the cluster section's lines
/[[:space:]]*cluster[[:space:]]*\{/ , /[^}]*\}/ { \

    # Deletes every line in the range except the first one
    /[^{]*\{/!d \

    # Add our config after the first line
    /[^{]*\{/ a\
\    name = \"${GANGLIA_NAME}\" \n\
    owner = \"${GANGLIA_OWNER}\" \n\
    latlong = \"${GANGLIA_LATLONG}\" \n\
    url = \"${GANGLIA_URL}\" \n\
}
}" $GMOND_CONF


# Replace the udp_send_channel section
sed -ri "
# Select the udp_send_channel section's lines
/[[:space:]]*udp_send_channel[[:space:]]*\{/ , /[^}]*\}/ { \

    # Deletes every line in the range except the first one
    /[^{]*\{/!d \

    # Add our config after the first line
    /[^{]*\{/ a\
\    host = ${FRONTEND_IP} \n\
    port = 8649 \n\
    ttl = 1 \n\
}
}" $GMOND_CONF
