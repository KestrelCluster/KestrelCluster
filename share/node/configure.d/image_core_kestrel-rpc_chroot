#!/bin/bash

# Install kestrel_connect and kestrel_disconnect commands on the image
#######################################################################

# Install the RPC client
cat << KESTREL > /sbin/kestrel_connect
#!/usr/bin/env python

# This script is the responsible of notifying the frontend via a rpc call the 
# started up of a node.
#
# The node notifies the frontend :
#
#    - the num of real cpus (using the command "num-of-cpus")
#    - the node image (reading the file /etc/kestrel_image_name)
#    - the node group while being registered (reading the cmdline)
#
#
# Note : Do NOT modify this file! 
#
# This file depends on the frontend's ip and port, and it is recreated each time
# the image is reconfigured.
# 
# If you wish to modify it, create your own copy of the template from :
#     /usr/lib/kestrel/node/configure.d/image_kestrel-rpc_chroot
# to :
#     /etc/kestrel/node/configure.d/image_kestrel-rpc_chroot
#

import re
import xmlrpclib
import subprocess

# Create the xmlrpc client
s = xmlrpclib.ServerProxy("http://${FRONTEND_IP}:${KESTREL_RPC_PORT}")

# Execute command num-of-cpus, and read the result
num_cpus=subprocess.Popen("num-of-cpus", shell=True, stdout=subprocess.PIPE, 
                          close_fds=True ).stdout.read()

# Read the kernel cmdline
f = open('/proc/cmdline', 'r')
cmdline=f.readline()
f.close()

# Read the image's name
f = open('/etc/kestrel_image_name', 'r')
image=f.readline()
f.close()


# Check if the client is in register mode, and save also the group
m = re.search("\sregister=([^\s]*)(?:\s|$)",cmdline)
if m:
    group=m.group(1)
    s.register(num_cpus, image, group)
    
else:
    
    s.connect(num_cpus, image)

KESTREL


cat << KESTREL > /sbin/kestrel_disconnect
#!/usr/bin/env python

import re, sys, xmlrpclib

s = xmlrpclib.ServerProxy("http://${FRONTEND_IP}:${KESTREL_RPC_PORT}")

# Check if the client is being shut down or being rebooted
if re.search("/etc/rc6\.d/",sys.argv[1]):
    s.disconnect(True)
else:
    s.disconnect(False)
KESTREL


# Give them read, write, and execute permissions
chmod 755 /sbin/kestrel_connect
chmod 755 /sbin/kestrel_disconnect


# Install kestrel_connect's and kestrel_disconnect's init.d services
#####################################################################

# Ubuntu and Debian differ significantly 

# Check the image distribution
if [ -e /etc/kestrel_image_os ]; then
    read IMAGE_OS < /etc/kestrel_image_os

# Ensure backwards compatibility (KestrelHPC < 1.9.14)
else
    # Save the Distribution's info
    OS_ARCHITECTURE=$(uname -m)
    OS_DISTRIBUTION=$(lsb_release -is)
    OS_CODENAME=$(lsb_release -cs)
    OS_RELEASE=$(lsb_release -rs)
    IMAGE_OS="${OS_ARCHITECTURE}-${OS_DISTRIBUTION}-${OS_CODENAME}-${OS_RELEASE}"
    echo "${IMAGE_OS}" > ${image_dir}/etc/kestrel_image_os
fi

# IMAGE_OS=${OS_ARCHITECTURE}-${OS_DISTRIBUTION}-${OS_CODENAME}-${OS_RELEASE}
case $IMAGE_OS in
    *)
        REQUIRED_START="\$remove_fs"
        REQUIRED_STOP=
        DEFAULT_START="2 3 4 5"
        DEFAULT_STOP=
        ;;
esac

# Install the init.d scripts
cat <<-INITD > /etc/init.d/kestrel_connect
#!/bin/bash
### BEGIN INIT INFO
# Provides:          kestrel_connect
# Required-Start:    ${REQUIRED_START}
# Required-Stop:     ${REQUIRED_STOP}
# Default-Start:     ${DEFAULT_START}
# Default-Stop:      ${DEFAULT_STOP}
# Short-Description: Kestrel Connect
# Description:       
### END INIT INFO

case "\$1" in
  start)
      /sbin/kestrel_connect
      ;;
  stop)
      ;;
esac
INITD

# IMAGE_OS=${OS_ARCHITECTURE}-${OS_DISTRIBUTION}-${OS_CODENAME}-${OS_RELEASE}
case $IMAGE_OS in
    *-Debian-*-*)
        REQUIRED_START=
        REQUIRED_STOP="\$umountfs"
        DEFAULT_START=
        DEFAULT_STOP="0 6"
        ;;
    *-Ubuntu-*-*)
        REQUIRED_START="\$umountfs"
        REQUIRED_STOP=
        DEFAULT_START="0 6"
        DEFAULT_STOP=
        ;;
esac

cat <<-INITD > /etc/init.d/kestrel_disconnect
#!/bin/bash
### BEGIN INIT INFO
# Provides:          kestrel_disconnect
# Required-Start:    ${REQUIRED_START}
# Required-Stop:     ${REQUIRED_STOP}
# Default-Start:     ${DEFAULT_START}
# Default-Stop:      ${DEFAULT_STOP}
# Short-Description: Kestrel Disconnect
# Description:       
### END INIT INFO

case "\$1" in
  start)
      ;;
  stop)
      /sbin/kestrel_disconnect $0
      ;;
esac
INITD

# Give them read, write, and execute permissions
chmod 755 /etc/init.d/kestrel_connect
chmod 755 /etc/init.d/kestrel_disconnect

update-rc.d -f kestrel_connect remove &>/dev/null
update-rc.d -f kestrel_disconnect remove &>/dev/null

update-rc.d kestrel_connect start 10 2 3 4 5 . &>/dev/null
update-rc.d kestrel_disconnect start 38 0 6 . &>/dev/null

