#!/bin/bash

# This script creates a new entry in the /etc/exports file for exporting
# "${image_name}" image. Since the exported directory has to be "mount binded" 
# to the real directory containing the image with nfs4, we also need to add an 
# entry on the fstab file for the "mount binding"

if [ "$1" == "uninstall" ]; then
    
    # Delete all kestrel's entries from the nfs export and the fstab
    sed -ri "/[^#]*\/kestrel(\/|[[:space:]])/d" ${FILE}

else
    new_mount_dir=${NFS4_ROOT}/kestrel/home

    # Remove old entries
    sed -ri "/[^#]*\/kestrel\/home(\s+|$)/d" ${FILE}

    comment="# Autogenerated by kestrel_reconfigure"

    grep -Eq "${comment}" ${FILE} || echo -e "\n${comment}" >> ${FILE}

    sed -ri "/${comment}/a\
${new_mount_dir} *(rw,async,nohide,no_subtree_check,no_root_squash) \n" ${FILE}
fi
