#!/bin/bash

if [ "$1" == "uninstall" ]; then
     
    # Delete all kestrel's entries from the nfs export and the fstab
    sed -ri "/${NFS4_ROOT//\//\\\/}\/kestrel/d" ${FILE}

else

# Remove old entries
sed -ri "/[^#]*[[:space:]].*\/kestrel\/home([^0-9A-Za-z]+|$)/d" ${FILE}

comment="# Autogenerated by kestrel_reconfigure"

new_mount_dir=${NFS4_ROOT}/kestrel/home

grep -Eq "${comment}" ${FILE} || echo -e "\n${comment}" >> ${FILE}

# Add the entry after the comment
sed -ri "/${comment}/a\
${KESTREL_HOME} \t${new_mount_dir} \tnode \tbind \t0 \t0 \n\
" ${FILE}

# Check if the image is already mounted somewhere else
mount_dir=$(mount | sed -rn \
           "s/.*\s([^\ \t]*\/kestrel\/home)\s+.*/\1/p")

echo "old mount_dir: ${mount_dir}"
echo "new mount_dir: ${new_mount_dir}"

# If the new mount dir is different from the old one, mount bind to the new dir
# first and then umount the old one
if [[ "${mount_dir}" != "${new_mount_dir}" ]]; then
    
    mkdir -p /${KESTREL_HOME#/}
    mkdir -p ${new_mount_dir}
    
    echo "Mounting new mount dir"
    echo "mount --bind \"/${KESTREL_HOME#/}\" \"${new_mount_dir}\""
    
    mount --bind /${KESTREL_HOME#/} ${new_mount_dir}
    
    if [ -n "${mount_dir}" ]; then
        echo "umount \"${mount_dir}\""
        umount ${mount_dir} > /dev/null
    fi
fi

fi
