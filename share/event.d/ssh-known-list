#!/bin/bash

# Check if the hostname is defined

[ ! -e  /etc/ssh/ssh_known_hosts ] &&
  touch /etc/ssh/ssh_known_hosts

tag="# Entry autogenerated by KestrelCluster"

case ${action} in
    connect|register)
        # Load the ssh key of the node
        key=$(awk '{print $2}' \
                  ${KESTREL_IMAGE_DIR}/${image}/etc/ssh/ssh_host_rsa_key.pub)

        # Update known hosts files
        [ -n "${hostname}" ] &&
        sed -ri "/^${hostname}\s.*${tag}/d"         /etc/ssh/ssh_known_hosts &&
        echo "${hostname} ssh-rsa ${key} ${tag}" >> /etc/ssh/ssh_known_hosts &&
        echo "added host:${hostname} with key:${key} from /etc/ssh/ssh_known_hosts"

        [ -n "${ip}" ] &&
        sed -ri "/^${ip}\s.*${tag}/d"               /etc/ssh/ssh_known_hosts &&
        echo "${ip} ssh-rsa ${key} ${tag}"       >> /etc/ssh/ssh_known_hosts &&
        echo "added ip:${ip} with key:${key} from /etc/ssh/ssh_known_hosts"
        ;;
        
    disconnect)
        [ -n "${hostname}" ] &&
        sed -ri "/^${hostname}\s/d"                 /etc/ssh/ssh_known_hosts &&
        echo "removed host:${hostname} from /etc/ssh/ssh_known_hosts"

        [ -n "${ip}" ] &&
        sed -ri "/^${ip}\s.*${tag}/d"               /etc/ssh/ssh_known_hosts &&
        echo "removed ip:${ip} from /etc/ssh/ssh_known_hosts"
        ;;
esac

:

