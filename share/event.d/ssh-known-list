#!/bin/bash

# Check if the hostname is defined
if [ -n "${hostname}" ]; then

[ ! -e  /etc/ssh/ssh_known_hosts ] &&
  touch /etc/ssh/ssh_known_hosts

tag="# Entry autogenerated by KestrelCluster"

case ${action} in
    connect|register)
        # Load the ssh key of the node
        key=$(awk '{print $2}' \
                  ${KESTREL_IMAGE_DIR}/${image}/etc/ssh/ssh_host_rsa_key.pub)

        # Update known hosts files
        sed -ri "/^${hostname}\s.*${tag}/d"         /etc/ssh/ssh_known_hosts
        sed -ri "/^${ip}\s.*${tag}/d"               /etc/ssh/ssh_known_hosts
        echo "${hostname} ssh-rsa ${key} ${tag}" >> /etc/ssh/ssh_known_hosts
        echo "${ip} ssh-rsa ${key} ${tag}"       >> /etc/ssh/ssh_known_hosts
        
        unset SSH_AUTH_SOCK
        
        su kestrel -c "ssh ${hostname} sudo dhclient"
        ;;
        
    disconnect)
        sed -ri "/^${hostname}\s/d"                 /etc/ssh/ssh_known_hosts
        sed -ri "/^${ip}\s.*${tag}/d"               /etc/ssh/ssh_known_hosts
        ;;
esac

fi
