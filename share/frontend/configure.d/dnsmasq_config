#!/bin/bash

if [[ ${DHCP_SERVER} != "true" ]]; then
    rm /etc/dnsmasq.d/kestrel &>/dev/null
    continue
fi


# Check if there is a dnsmasq.conf file, and ensure "dnsmasq.d" dir is enabled
[ -e /etc/dnsmasq.conf ] || continue

# Uncomment ubuntu's default config for enabling dnsmasq.d dir
sed -ri '/conf-dir[[:space:]]*=[[:space:]]*\/etc\/dnsmasq.d/s/^#[[:space:]]*//' \
        /etc/dnsmasq.conf

# Ensure the config dir dnsmasq.d is enabled
if ! grep -qE "[[:space:]]*conf-dir[[:space:]]*=[[:space:]]*\/etc\/dnsmasq.d" \
              /etc/dnsmasq.conf; then
    cat <<-CONFIG >> /etc/dnsmasq.conf
    conf-dir=/etc/dnsmasq.d
CONFIG
fi

install -d /etc/dnsmasq.d/


# Config template
cat <<DNSMASQ > /etc/dnsmasq.d/kestrel
#
# File autogenerated by kestrel-reconfigure on $(date)
# 
# Do not edit it directly! Instead create a new file at /etc/dnsmasq.d/.
# 
# If you wish to modify heavily the autogeneration template, copy the script
# from /usr/lib/kestrel/frontend/config.d/dnsmasq.conf to 
# /etc/kestrel/frontend/config.d/dnsmasq.conf to ensure updates don't delete
# your customizations.
#

# Read the IP addresses of the upstream nameservers from <file>, instead of 
# /etc/resolv.conf
#resolv-file=/etc/resolv.conf.real

# Listen on the given IP address(es)
listen-address=${FRONTEND_IP},127.0.0.1

# Enable  the  DHCP server. Addresses will be given out from the range 
# <start-addr> to <end-addr> and from statically defined # addresses given in 
# dhcp-host options
dhcp-range=${DHCP_STARTING_IP},${DHCP_ENDING_IP},12h

# Specify different or extra options to DHCP clients
dhcp-option=option:router,${FRONTEND_IP}
dhcp-option=option:tftp-server,${FRONTEND_IP}

# Set  BOOTP  options to be returned by the DHCP server.
dhcp-boot=pxelinux.0,$(hostname),${FRONTEND_IP}

# Enable the TFTP server function.
enable-tftp

# Make the TFTP server more secure: with this set, only files owned by
# the user dnsmasq is running as will be send over the net.
tftp-secure

# Look for files to transfer using TFTP relative to the given directory.
tftp-root=${TFTPBOOT_DIR}

# Should  be set when dnsmasq is definitely the only DHCP server on a network.
# It changes the behaviour from strict RFC compliance so that DHCP requests on
# unknown leases from unknown hosts are not ignored
#dhcp-authoritative

# Read /etc/ethers for information about hosts for the DHCP server.
#read-ethers
dhcp-hostsfile=${KESTREL_REG_NODES}

# Extra logging for DHCP: log all the options sent to DHCP clients and the netid
# tags used to  determine them.
log-dhcp

#script=${KESTREL_SHARE}/dhcp-script
DNSMASQ

run_from_script /etc/init.d/dnsmasq restart &>/dev/null

