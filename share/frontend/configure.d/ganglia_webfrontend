#!/bin/bash

# This script reconfigures gmond's config file :
#   - Sets gmond's user to ganglia
#   - Sets gmond to mute mode. A frontend doesn't send data to other nodes.
#   - Sets gmond's cluster info : name, owner, latlong and url
#   - Sets udp_recv_channel to unicast instead of multicast
#
# And also reconfigures gmetd's config file :
#   - Set's gmetd's user to ganglia
#   - Set's the data_source : data_source "cluster's name" localhost

# Note: Although the following sed script may seem too complex and a simpler
# template based approach would seem more appropiate, this is the best approach
# since it just tries to modify only some sections of the default config. 
# In the future the default gmond config may include new interesting metrics,
# which will work out of the box.

# Ganglia Monitor Daemon's config
##################################

GMOND_CONF=/etc/ganglia/gmond.conf

# Backup original gmond
if [ ! -e ${GMOND_CONF}.bak ]; then
   cp ${GMOND_CONF} ${GMOND_CONF}.bak
fi

cat <<MESSAGE > $GMOND_CONF
/*
File autogenerated by kestrel-reconfigure on $(date)

Do not edit this file directly!

If you want to edit it, the best approach is to edit the autogeneration 
template. Copy the script from /usr/share/kestrel/frontend/config.d/ganglia to 
/etc/kestrel/frontend/config.d/ganglia, and modify it. 

A simpler option is to create a simple template :

Create a file /etc/kestrel/frontend/config.d/ganglia with the content :

#!/bin/bash
cat <<CONTENT > $GMOND_CONF

...The edited file...

CONTENT

*/
MESSAGE

# Create a new default config file
gmond -t >> $GMOND_CONF
#cat ${GMOND_CONF}.bak >> ${GMOND_CONF}

# Set the user as ganglia
sed -ri 's/^([[:space:]]*user[[:space:]]*=).*/\1 ganglia/' $GMOND_CONF

# Set gmond as mute. A frontend doesn't need to send data to other nodes.
#sed -ri 's/^([[:space:]]*mute[[:space:]]*=).*/\1 yes/' $GMOND_CONF

# Replace the cluster section
sed -ri "
# Select the cluster section's lines
/[[:space:]]*cluster[[:space:]]*\{/ , /[^}]*\}/ { \

    # Deletes every line in the range except the first one
    /[^{]*\{/!d \

    # Add our config after the first line
    /[^{]*\{/ a\
\    name = \"${GANGLIA_NAME}\" \n\
    owner = \"${GANGLIA_OWNER}\" \n\
    latlong = \"${GANGLIA_LATLONG}\" \n\
    url = \"${GANGLIA_URL}\" \n\
}
}
/path[[:space:]]+=[[:space:]]+\"([^/]*)\"/s##path = \"/usr/lib/ganglia/\1\"#
" $GMOND_CONF

# Replace the udp_recv_channel section
sed -ri "
# Select the udp_recv_channel section's lines
#/[[:space:]]*udp_recv_channel[[:space:]]*\{/ , /[^}]*\}/ { \

    # Deletes every line in the range except the first one
#    /[^{]*\{/!d \

    # Add our config after the first line
#    /[^{]*\{/ a\
#\    port = 8649 \n\
#    family = inet4 \n\
#}
#}" $GMOND_CONF

run_from_script /etc/init.d/ganglia-monitor restart &>/dev/null


# Ganglia Meta Daemon's config
###############################

GMETAD_CONF=/etc/ganglia/gmetad.conf

# If the file doen's exist, create it
if [ ! -e "${GMETAD_CONF}" ]; then
   touch ${GMETAD_CONF}

# Backup original gmond
elif [ ! -e "${GMETAD_CONF}.bak" ]; then
   cp ${GMETAD_CONF} ${GMETAD_CONF}.bak
fi

# Update/Replace data_source and setuid_username
sed -ri "s/^[[:space:]]*data_source.*/data_source \"${GANGLIA_NAME}\" localhost/" ${GMETAD_CONF}
#sed -ri "s/^[[:space:]]*setuid_username.*/setuid_username \"ganglia\"/" ${GMETAD_CONF}

# If the file doesn't define the data_source, define it
if ! grep -Eq "^[[:space:]]*data_source" ${GMETAD_CONF}; then
   cat <<-CONFIG >> ${GMETAD_CONF}
   data_source "${GANGLIA_NAME}" localhost
CONFIG
fi

# If the file doesn't define the setuid_username, define it
#if ! grep -Eq "^[[:space:]]*setuid_username" ${GMETAD_CONF}; then
#   cat <<-CONFIG >> ${GMETAD_CONF}
#   setuid_username "ganglia"
#CONFIG
#fi

run_from_script /etc/init.d/gmetad restart &>/dev/null
