#!/bin/bash

# Copyright (C) 2011 Jon Ander Hern√°ndez
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.


# kestrel-chroot-lib
#
# Minimal reconfigure library. Functions defined in this library can be used
# on scripts run on the images under a chroot enviroment.


# File copying functions
#########################

# All this functions expect to have ${os_dir} variable correctly set

# copy_file <file> <to_file>
# 

copy_file() {
    local   file="${1}"
    local tofile="${2#${os_dir}}"
    
    test_backup
    
    cp -a "${file}" "${os_dir}/${tofile}"
    
    perms_and_backup
}


# copy_file <file> <to_file>
# 

link_file() {
    local   file="${1%\(*\)}"
    local tofile="${2#${os_dir}}"
    
    test_backup
    
    ( cd "${os_dir}/${file%/*}"
      ln -snf "${file##*/}" "${tofile}" )
    
    perms_and_backup
}


# template_file <file> <to_file>
# 

template_file() {
    local   file="${1}"
    local tofile="${2#${os_dir}}"
    
    test_backup
    
    evaluate_template < "${file}" > "${os_dir}/${tofile}"
    
    perms_and_backup
}


# test_backup
# 
#     Makes the original backup when kestrel is installed, and also checks if 
#     a file has been modified by the user since the last reconfiguration.

test_backup() {
    local dest_file="${os_dir}/${tofile}"
    local back_file="${os_dir}/${KESTREL_BACKUP_DIR}/${tofile}"
    local last_file
    local orig_file
    local dest_stat
    
    mkdir -p "${dest_file%/*}"
    mkdir -p "${back_file%/*}"
    
    if [ -f "${dest_file}" ]; then
        dest_stat=$(stat -c %Y "${dest_file}")
        
        # If the file has not been changed by the user, remove the backup of the
        # autogenerated file.
        if [ -L "${back_file}:last" ]; then
            last_file=$(readlink -n  "${back_file}:last")
            orig_file=$(readlink -ns "${back_file}:orig")
            
            [ "${dest_stat}" ==  "${last_file##*:}" ] &&
              [ "${last_file}" != "${orig_file}" ] &&
                rm -f "${back_file%/*}/${last_file}"
        
        # When installing the first time save the original file
        elif [[ "${event}" == @(install|enable) && ! -d "${dest_file}" &&
           ! -L "${back_file}:orig" && "${dest_stat}" != "0" ]]; then
            
            cp -a "${dest_file}" "${back_file}:${dest_stat}"
            
            ( cd "${back_file%/*}"
              ln -snf "${back_file##*/}:${dest_stat}" "${back_file##*/}:orig" )
        fi
    else
        touch -d "@0" "${dest_file}"
    fi
}


# perms_and_backup
# 
#     Apply permissions and make a backup of the file.

perms_and_backup() {
    local dest_file="${os_dir}/${tofile}"
    local back_file="${os_dir}/${KESTREL_BACKUP_DIR}/${tofile}"
    local dest_stat
    
    [ -n "${user}"  ] && chown "${user}"   "${dest_file}"
    [ -n "${group}" ] && chown ":${group}" "${dest_file}"
    [ -n "${mode}"  ] && chmod "${mode}"   "${dest_file}"
    [ -n "${link}"  ] && link_file "${dest_file}" "${link}"
    
    mkdir -p "${back_file%/*}"
    
    if [[ -e "${dest_file}" && ! -d "${dest_file}" ]]; then
        dest_stat=$(stat -c %Y "${dest_file}")
        
        cp -a "${dest_file}" "${back_file}:${dest_stat}"
        
        ( cd "${back_file%/*}"
          ln -snf "${back_file##*/}:${dest_stat}" "${back_file##*/}:last" )
    fi
}

# restore_file
# 

restore_file() {
    local dest_file="${os_dir}/${file}"
    local back_file="${os_dir}/${KESTREL_BACKUP_DIR}/${file}"
    local orig_link="${back_file}:orig"
    local orig_file=$(readlink -n "${orig_link}")
    
    # If the file has not been changed by the user, remove the backup of the
    # last autogenerated file.
    if [ -L "${back_file}:last" ]; then
        
        local dest_stat=$(stat -c %Y "${dest_file}")
        local last_file=$(readlink -n "${back_file}:last")
        local last_stat="${last_file##*:}"
        
        # Compare the actual stat, and the stat (of the name) of the last backup
        if [ "${dest_stat}" ==  "${last_stat}" ]; then
            [ "${last_file}" != "${orig_file}" ] &&
              rm "${back_file%/*}/${last_file}"
        else
            cp -a "${dest_file}" "${back_file}:${dest_stat}"
        fi
        
        rm "${back_file}:last"
        
        # If there was a backup, restore the backup
        if [ -L "${orig_link}" ]; then
            cp -a "${back_file%/*}/${orig_file}" "${dest_file}"
            
            #[[ "${event}" == @(uninstall|disable) ]] &&
            #rm "${orig_link}"
        
        # Otherwise simply delete the file
        else
            [ -f "${dest_file}" ] &&
            rm "${dest_file}"
        fi
    fi
}


# File editing functions
#########################

# evaluate_template
# 

evaluate_template() {
    sed -r "${evaluation_script}"
}


# set_key_value <key> <value> <file> [<separator_re> [<separator> [<space>]]]
# 
#     Helps replacing/setting key-values on files.
#     By default the separator is the "=" character.
#     
#     Optional parameters
#         <separator_re>: Regular expression used to match the separator.
#         
#         <separator>   : Use <separator> if <separator_re> is not a printable
#                         expression.
#         
#         <space>       : Regular expression used to match the ignored spaces.
#                         By default "[:space:]*"
#         
#     Examples:
#         set_key_value FRONTEND_IP "192.168.30.1" /etc/kestrel/kestrel.conf
#         
#         set_key_value PrintMotd no /etc/ssh/sshd_config " "
#             Use a space as the separator
#

set_key_value() {
    local    key="${1}"
    local  value="${2}"
    local   file="${3}"
    
    local sep_re="${4:-=}"
    local    sep="${5:-${sep_re}}"
    local  space="${6:-\s*}"
    
    [ -d ${file%/*} ] || mkdir -p ${file%/*}
    
    # If a whitespace is used as a separator, generalize its regular expression
    [[ "${sep_re}" == " " && "${sep}" == " " ]] && sep_re="\s"
    
    if [ ! -e ${file} ] || ! grep -qE "^${space}${key}${space}${sep_re}" ${file}
    then
        echo "${key}${sep}${value}" >> ${file}
    else
        sed -ri "/^(${space})${key}${sep}.*$/s||\1${key}${sep}${value}|" ${file}
    fi
}

